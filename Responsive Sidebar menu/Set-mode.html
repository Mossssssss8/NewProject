<!DOCTYPE html>
<!-- Created by CodingLab |www.youtube.com/c/CodingLabYT-->
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">
    <title> Human Pose Estimation Technology </title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <!-- Boxicons CDN Link -->
    <script src="https://cdn.jsdelivr.net/npm/p5@1.4.1/lib/p5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.4.1/lib/addons/p5.sound.min.js"></script>
    <script src="https://unpkg.com/ml5@0.4.2/dist/ml5.min.js"></script>
    <link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>\
    <script type="text/javascript" src="https://unpkg.com/webcam-easy/dist/webcam-easy.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils_3d/control_utils_3d.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body onload="init()">
    <div class="sidebar">
        <div class="logo-details">
            <i class='#'></i>
            <div class="logo_name">Human Pose</div>
            <i class='bx bx-menu' id="btn"></i>
        </div>
        <ul class="nav-list" style="margin-left: -30px;">
            <li>
                <i class='bx bx-search'></i>
                <input type="text" placeholder="Search...">
                <span class="tooltip">Search</span>
            </li>
            <li>
                <a href="index.html">
                    <i class='bx bx-grid-alt'></i>
                    <span class="links_name">Dashboard</span>
                </a>
                <span class="tooltip">Dashboard</span>
            </li>
            <li>
                <a href="Set-mode.html">
                    <i class='bx bx-menu'></i>
                    <span class="links_name">Set mode</span>
                </a>
                <span class="tooltip">Set mode</span>
            </li>
            <!-- <li>
       <a href="user.html">
         <i class='bx bx-user' ></i>
         <span class="links_name">User</span>
       </a>
       <span class="tooltip">User</span>
     </li> -->
            <li>
                <a href="Video.html">
                    <i class='bx bx-video'></i>
                    <span class="links_name">Video</span>
                </a>
                <span class="tooltip">Video</span>
            </li>
            <li>
                <a href="History.html">
                    <i class='bx bx-pie-chart-alt-2'></i>
                    <span class="links_name">History</span>
                </a>
                <span class="tooltip">History</span>
            </li>
            <li>
                <a href="setting.html">
                    <i class='bx bx-cog'></i>
                    <span class="links_name">Setting</span>
                </a>
                <span class="tooltip">Setting</span>
            </li>
            <li class="profile">
                <div class="profile-details">
                    <!-- <img src="profile.jpg" alt="profileImg"> -->
                    <div class="name_job">
                        <div id="ShowUserName" class="name">User</div>
                        <div class="job">Web Human Pose</div>
                    </div>
                </div>
                <button><i class='bx bx-log-out' title="Log out!" onclick="logout()" id="log_out"></i></button>
            </li>
        </ul>
    </div>
    <section class="home-section">
        <div class="text">Set mode</div>
        <button type="button" class="btn btn-secondary btn-lg" href="#">HIIT Mode</button>
        <button type="button" class="btn btn-secondary btn-lg" href="#">Endurance Mode</button>

        <h1> Counter : <span id="showCounter">0 </span></h1>
        <div class="container">
            <video class="input_video"></video>
            <canvas class="output_canvas" width="1280px" height="720px"></canvas>
            <div class="landmark-grid-container"></div>
        </div>
        <script src="script.js"></script>

        <script type="module">
            const videoElement = document.getElementsByClassName('input_video')[0];
            const canvasElement = document.getElementsByClassName('output_canvas')[0];
            const canvasCtx = canvasElement.getContext('2d');
            const landmarkContainer = document.getElementsByClassName('landmark-grid-container')[0];
            const grid = new LandmarkGrid(landmarkContainer);
            var counter = 0;
            var stage = "down";
            function onResults(results) {
                if (!results.poseLandmarks) {
                    grid.updateLandmarks([]);
                    return;
                }

                canvasCtx.save();
                canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
                canvasCtx.drawImage(results.segmentationMask, 0, 0,
                    canvasElement.width, canvasElement.height);

                // Only overwrite existing pixels.
                canvasCtx.globalCompositeOperation = 'source-in';
                canvasCtx.fillStyle = '#00FF00';
                // canvasCtx.fillRect(0, 0, canvasElement.width, canvasElement.height);

                // Only overwrite missing pixels.
                canvasCtx.globalCompositeOperation = 'destination-atop';
                canvasCtx.drawImage(
                    results.image, 0, 0, canvasElement.width, canvasElement.height);

                canvasCtx.globalCompositeOperation = 'source-over';
                drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS,
                    { color: '#00FF00', lineWidth: 4 });
                drawLandmarks(canvasCtx, results.poseLandmarks,
                    { color: '#FF0000', lineWidth: 2 });
                canvasCtx.restore();

                getPoseLandmarks(results.poseLandmarks)

                grid.updateLandmarks(results.poseWorldLandmarks);
            }

            const pose = new Pose({
                locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
                }
            });
            pose.setOptions({
                modelComplexity: 1,
                smoothLandmarks: true,
                enableSegmentation: true,
                smoothSegmentation: true,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });
            pose.onResults(onResults);

            const camera = new Camera(videoElement, {
                onFrame: async () => {
                    await pose.send({ image: videoElement });
                },
                width: 1280,
                height: 720
            });
            camera.start();

            function getPoseLandmarks(poseLandmarks) {
                var hipRight = poseLandmarks[24];
                var kneeRight = poseLandmarks[26];
                var AnkleRight = poseLandmarks[28];
                var angle = calculate_angle(hipRight, kneeRight, AnkleRight);

                countScoreSquats(angle, poseLandmarks);

                // console.log(poseLandmarks)
                // console.log(poseLandmarks)
            }

            function countScoreSquats(angle, poseLandmarks) {
                if (CheckSpot(poseLandmarks)) {
                    if (angle > 160) {
                        stage = "down"
                    }
                    if (angle < 75 && stage == "down") {
                        counter++;
                        stage = "up";
                        // success
                        // change score
                        document.getElementById("showCounter").innerHTML = counter;
                        console.log(poseLandmarks)
                    }
                }

            }

            function calculate_angle(hip, knee, ankle) {
                var a = [hip.x, hip.y];
                var b = [knee.x, knee.y];
                var c = [ankle.x, ankle.y];

                var radians = Math.atan2(c[1] - b[1], c[0] - b[0]) - Math.atan2(a[1] - b[1], a[0] - b[0]);
                var angle = Math.abs(radians * 180.0 / Math.PI)

                if (angle > 180.0) {
                    angle = 360 - angle
                }
                return angle;
            }

            function CheckSpot(poseLandmarks) {
                var footLeft = poseLandmarks[31];
                var footRight = poseLandmarks[32];
                var isCorrect = false;
                var correctPercent = 0.68;
                if (footLeft.visibility > correctPercent && footRight.visibility > correctPercent) {
                    isCorrect = true;
                }
                return isCorrect;
            }

        </script>

</body>

</html>